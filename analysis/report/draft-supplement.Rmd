---
title: "Comparative vaccine effectiveness of ChAdOx1 versus BNT162b2 in Health and Social Care workers in England: Supplementary materials"
output:
  html_document: 
    keep_md: yes
    self_contained: TRUE
  word_document: default
  bookdown::html_document2:
    number_sections: false
    toc: false
#bibliography: references.bib
#csl: nature.csl # from https://raw.githubusercontent.com/citation-style-language/styles/master/nature.csl
#link-citations: yes
#zotero: true
---

```{r setup, include=FALSE}

library('tidyverse')
library('here')
library('glue')
library('lubridate')
library('gt')
library('patchwork')
library('scales')
source(here("analysis", "lib", "utility_functions.R"))


output_dir <- here("output")

fs::dir_create(output_dir, "report", "figures")

knitr::opts_chunk$set(
  echo = TRUE,
  fig.path = paste0(fs::path(output_dir, "report", "figures"), "/")
)

gbl_vars <- jsonlite::fromJSON(
  txt=here("analysis", "global-variables.json")
)

data_cohort <- read_rds(here("output", "data", "data_cohort.rds"))

flowchart <- read_csv(here("output", "data", "flowchart.csv"))

metadata_outcomes <- read_rds(here("output", "data", "metadata_outcomes.rds"))

list_formula <- read_rds(here("output", "data", "metadata_formulas.rds"))
list2env(list_formula, globalenv())
lastfupday <- lastfupday20
```

```{r characteristics, echo=FALSE, warning=FALSE, message=FALSE}


data_cohort <- 
  data_cohort %>%
  mutate(
    censor_date = pmin(vax1_date - 1 + lastfupday, end_date, dereg_date, death_date, vax2_date, na.rm=TRUE),
    tte_censor = tte(vax1_date-1, censor_date, censor_date, na.censor=TRUE),

    postest = censor_indicator(positive_test_date, censor_date),
    emergency = censor_indicator(emergency_date, censor_date),
    covidemergency = censor_indicator(emergency_covid_date, censor_date),
    admitted = censor_indicator(admitted_date, censor_date),
    covidadmitted = censor_indicator(covidadmitted_date, censor_date),
    covidcc = censor_indicator(covidcc_date, censor_date),
    coviddeath = censor_indicator(coviddeath_date, censor_date),
    death = censor_indicator(death_date, censor_date),
  ) 

baseline <- 
  data_cohort %>%
  summarise(
    n = n(),
    age_median = median(age),
    age_Q1 = quantile(age, 0.25),
    age_Q3 = quantile(age, 0.75),
    female = mean(sex=="Female"),
    fu_years = sum(tte_censor)/365.25,
    fu_median = median(tte_censor),
    priorinfection = mean(prior_covid_infection),
    
    
    
    postest = sum(postest),
    emergency = sum(emergency),
    admitted = sum(admitted),
    covidadmitted = sum(covidadmitted),
    coviddeath = sum(coviddeath),
    death = sum(death),
  )

baseline_az <- 
  data_cohort %>%
  filter(vax1_type=="az") %>%
  summarise(
    n = n(),
    age_median = median(age),
    age_Q1 = quantile(age, 0.25),
    age_Q3 = quantile(age, 0.75),
    female = mean(sex=="Female"),
    fu_years = sum(tte_censor)/365.25,
    fu_median = median(tte_censor),
    priorinfection = mean(prior_covid_infection),
    median_vaxday = first(start_date_az) + floor(median(vax1_day)) -1
  )

baseline_pfizer <- 
  data_cohort %>%
  filter(vax1_type=="pfizer") %>%
  summarise(
    n = n(),
    age_median = median(age),
    age_Q1 = quantile(age, 0.25),
    age_Q3 = quantile(age, 0.75),
    female = mean(sex=="Female"),
    fu_years = sum(tte_censor)/365.25,
    fu_median = median(tte_censor),
    priorinfection = mean(prior_covid_infection),
    median_vaxday = first(start_date_az) + floor(median(vax1_day)) - 1
  )
```

```{r, effects, echo=FALSE, message=FALSE, warning=FALSE}

  outcomes <- 
    c(
      "postest",
      "emergency",
      "covidadmitted"
    ) %>% 
    set_names(., .)

  cmlinc <-
    map_dfr(
      outcomes,
      ~read_rds(here("output", "models", .x, "timesincevax", "0", glue("reportplr_adjustedsurvival_ns.rds"))),
      .id="outcome"
    ) %>%
    left_join(metadata_outcomes, by="outcome") %>%
    mutate(
      outcome_descr = fct_inorder(outcome_descr),
      model_name = fct_inorder(str_wrap(model_name, 15))
    ) %>%
    filter(model %in% c(1,2))
  
  plot_cmlinc <- function(model){
    modell <- model
    
    cmlinc %>%
      filter(model == modell) %>%
      ggplot(cmlinc)+
      geom_step(aes(x=tstop, y=(1-survival)*1000, group=vax1_az_descr, colour=vax1_az_descr))+
      geom_rect(aes(xmin=lag(tstop, 1, 0), xmax=tstop, ymin=(1-survival.ll)*1000, ymax=(1-survival.ul)*1000, group=vax1_az_descr, fill=vax1_az_descr), alpha=0.1)+
      geom_hline(aes(yintercept=0), colour='black')+
      facet_grid(cols=vars(outcome_descr))+
      scale_x_continuous(
        breaks = seq(0,7*52,by=14),
        expand = expansion(0)
      )+
      scale_y_continuous(
        expand = expansion(0),
        limits = c(0L,NA)
      )+
      scale_colour_brewer(type="qual", palette="Set1", na.value="grey")+
      scale_fill_brewer(type="qual", palette="Set1", guide="none", na.value="grey")+
      labs(
        x=NULL,
        y="Marginalised cumulative incidence\nper 1000",
        colour=NULL
      )+
      theme_minimal()+
      theme(
        legend.position=c(0.1,0.95),
        legend.justification = c(0,1),
        legend.direction = "vertical",
        axis.text.x.top=element_text(hjust=0),
  
        panel.border = element_blank(),
        axis.line.y = element_line(colour = "black"),
        axis.line.x.top = element_line(colour = "black"),
  
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.background = element_blank(),
  
  
        panel.spacing = unit(0.8, "lines"),
  
      )+
      NULL
  }
  
  
  
  hazard <-
    map_dfr(
      outcomes,
      ~read_rds(here("output", "models", .x, "timesincevax", glue("reportplr_effects_ns.rds"))),
      .id="outcome"
    ) %>%
    left_join(metadata_outcomes, by="outcome") %>%
    mutate(
      outcome_descr = fct_inorder(outcome_descr),
      model_name = fct_inorder(str_wrap(model_name, 15))
    ) %>%
    filter(model %in% c(1,2))

  
  
  plot_hazard <- function(model){
    modell <- model
    
    hazard %>% 
      filter(model == modell) %>%
      ggplot()+
      geom_hline(aes(yintercept=1), colour='black')+
      geom_line(aes(x=tstop, y=hr), colour='orchid4')+
      geom_ribbon(aes(x=tstop, ymin=hr.ll, ymax=hr.ul), alpha=0.1, colour="transparent", fill='orchid4')+
      facet_grid(cols=vars(outcome_descr))+
      scale_x_continuous(
        limits = c(0, NA),
        breaks = seq(0,7*52,by=14),
        expand = expansion(0)
      )+
      scale_y_log10(
        #breaks=c(0.125, 0.167, 0.25, 0.333, 0.5, 0.667, 1, 1.5, 2, 3, 4, 6, 8),
        sec.axis = dup_axis(name="Lower hazard after \n <- BNT162b2 / ChAdOx1 ->", breaks = NULL)
      )+
      coord_cartesian(ylim= c(0.1, 10))+
      labs(
        x = "Days since first dose",
        y = "Hazard ratio"
      )+
      theme_bw()+
      theme(
        panel.border = element_blank(),
        axis.line.y.left = element_line(colour = "black"),
  
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank(),
  
        panel.spacing = unit(0.8, "lines"),
  
        plot.title = element_text(hjust = 0),
        plot.title.position = "plot",
        plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0, face= "italic")
  
       ) +
     NULL
  }
  
  
  riskdiff <-
    map_dfr(
      outcomes,
      ~read_rds(here("output", "models", .x, "timesincevax", "0", glue("reportplr_adjusteddiff_ns.rds"))),
      .id="outcome"
    ) %>%
    left_join(metadata_outcomes, by="outcome") %>%
    mutate(
      outcome_descr = fct_inorder(outcome_descr),
      model_name = fct_inorder(str_wrap(model_name, 15)),
      diff_format = label_number(0.01, scale=1000)(diff),
      diff_CI = paste0("(" , label_number(0.01, scale=1000)(diff.ll), ", ", label_number(0.01, scale=1000)(diff.ul), ")")
    ) %>%
    filter(model %in% c(1,2))
  
  
  plot_riskdiff <- function(model){
    
    modell <- model
    riskdiff %>%
      filter(model==modell) %>%
      ggplot(riskdiff)+
      geom_hline(aes(yintercept=0), colour='black')+
      geom_step(aes(x=tstop, y=diff*1000), colour='orchid4')+
      geom_rect(aes(xmin=lag(tstop, 1, 0), xmax=tstop, ymin=diff.ll*1000, ymax=diff.ul*1000), alpha=0.1, colour="transparent", fill='orchid4')+
      facet_grid(cols=vars(outcome_descr))+
      scale_x_continuous(
        limits = c(0, NA),
        breaks = seq(0,7*52,by=14),
        expand = expansion(0)
      )+
      scale_y_continuous(
        expand = expansion(0),
        sec.axis = dup_axis(name="Lower risk after \n <- BNT162b2 / ChAdOx1 ->", breaks = NULL)
      )+
      coord_cartesian(ylim= c(-5, 5))+
      scale_colour_brewer(type="qual", palette="Set1", na.value="grey")+
      scale_fill_brewer(type="qual", palette="Set1", guide="none", na.value="grey")+
      labs(
        x=NULL,
        y="Difference\nin cumulative incidence\nper 1000",
        colour=NULL
      )+
      theme_bw()+
      theme(
        panel.border = element_blank(),
        axis.line.y.left = element_line(colour = "black"),
  
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank(),
  
        panel.spacing = unit(0.8, "lines"),
  
        plot.title = element_text(hjust = 0),
        plot.title.position = "plot",
        plot.caption.position = "plot",
        plot.caption = element_text(hjust = 0, face= "italic")
  
       ) +
     NULL
  }

```

#### Supplmentary Figure 1a: Comparative effectiveness using a minimally adjusted model

```{r comp1, echo=FALSE, message=FALSE, warning=FALSE, out.width='90%', fig.height=8, results='asis'}
patchwork::wrap_plots(plot_cmlinc(1), plot_riskdiff(1), plot_hazard(1), ncol=1)
```

#### Supplmentary Figure 1b: Comparative effectiveness using a demographically adjusted model

```{r comp2, echo=FALSE, message=FALSE, warning=FALSE, out.width='90%', fig.height=8, results='asis'}
patchwork::wrap_plots(plot_cmlinc(2), plot_riskdiff(2), plot_hazard(2), ncol=1)
```

#### Supplmentary Figure 2: Second dose interval by vaccine type

Second doses are censored by study end date, de-registration, death, and additionally by outcome-specific events.

```{r seconddose_postest, echo=FALSE, message=FALSE, warning=FALSE, out.width='90%', fig.height=8, results='asis'}
plot_seconddose_all <- read_rds(here("output", "descriptive", "secondose", "plot_seconddose_all.rds"))
plot_seconddose_all
```

#### Supplmentary Table 1: Baseline characteristics before eligibility exclusions

Characteristics for all HCWs aged 18-64 receiving a first dose of BNT162b2 or ChAdOx1 between 4 January and 28 February 2021 and actively registered at at TPP practice are reported, before exclusions due to missing demographic characteristics and Clinically Extremely Vulnerable status.

```{r table1_allvax, echo=FALSE, warning=FALSE, message=FALSE}
read_rds(here("output", "descriptive", "tables", "table1_allvax.rds"))
```
